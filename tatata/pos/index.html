<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud POS System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Classy-Cute Color Theme */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; /* Professional yet friendly */
            margin: 20px;
            background-color: #f8f7f5; /* Off-white, subtle warm tone */
            color: #4a4a4a; /* Dark gray for general text */
        }
        .container-fluid {
            padding: 30px;
            background-color: #ffffff; /* Clean white for the main container */
            border-radius: 12px; /* Gently rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Soft, elegant shadow */
        }
        .nav-tabs {
            border-bottom: 2px solid #e0e0e0; /* Light gray border */
        }
        .nav-tabs .nav-link {
            cursor: pointer;
            color: #888; /* Muted gray for inactive tabs */
            border: 1px solid transparent;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            padding: 10px 18px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-tabs .nav-link:hover {
            color: #725d68; /* Subtle hover color */
            border-color: #f2f2f2;
        }
        .nav-tabs .nav-link.active {
            background-color: #e0d9e4; /* Soft lavender-gray for active tab */
            color: #5d4037; /* Dark brown text for contrast */
            border-color: #d0c8d4;
            font-weight: 600;
        }
        .tab-content {
            margin-top: 25px;
            background-color: #fefefe; /* Very light background for content areas */
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #f0f0f0; /* Very subtle border */
        }
        h1, h2, h3 {
            color: #725d68; /* Muted plum/mauve for headings */
            font-weight: 700;
            margin-bottom: 20px;
        }
        .form-label {
            color: #5a5a5a; /* Slightly darker gray for labels */
            font-weight: 600;
        }
        .form-control, .form-select {
            border-color: #d0d0d0; /* Soft gray border for inputs */
            border-radius: 6px; /* Standard rounded inputs */
            padding: 0.75rem 1rem;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(176, 170, 180, 0.25); /* Subtle focus glow */
            border-color: #b0aaac;
        }
        /* Button Styles */
        .btn {
            border-radius: 8px; /* Gently rounded buttons */
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Very light shadow for depth */
        }
        .btn-primary {
            background-color: #9b8a9b; /* Muted plum */
            border-color: #9b8a9b;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #7e6f7e; /* Darker plum on hover */
            border-color: #7e6f7e;
        }
        .btn-success {
            background-color: #a7c5a0; /* Soft sage green */
            border-color: #a7c5a0;
            color: #fff;
        }
        .btn-success:hover {
            background-color: #8dae88; /* Darker sage green */
            border-color: #8dae88;
        }
        .btn-info {
            background-color: #c9b3d0; /* Soft lavender */
            border-color: #c9b3d0;
            color: #fff;
        }
        .btn-info:hover {
            background-color: #b095b8; /* Darker lavender */
            border-color: #b095b8;
        }
        .btn-danger {
            background-color: #e0a9a1; /* Muted rose */
            border-color: #e0a9a1;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #c98e87; /* Darker rose */
            border-color: #c98e87;
        }

        pre {
            background-color: #fef8f0; /* Creamy background for receipts */
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #f3e8d7; /* Soft border */
            color: #5d4037; /* Dark brown text for readability */
            font-family: 'Consolas', 'Monaco', monospace; /* Monospaced for receipt feel */
            font-size: 0.95em;
        }
        .table-container {
            max-height: 450px; /* Slightly taller table */
            overflow-y: auto;
            border: 1px solid #e8e8e8; /* Light gray border */
            border-radius: 8px;
        }
        .table {
            background-color: #ffffff; /* White table background */
            margin-bottom: 0; /* Remove default table margin if inside container */
        }
        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f5f5f5; /* Light gray header */
            color: #725d68; /* Heading color for text */
            z-index: 1;
            font-weight: 700;
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer; /* Indicate sortable */
            user-select: none; /* Prevent text selection on double click */
        }
        .table thead th .sort-icon {
            margin-left: 8px;
            transition: transform 0.2s ease;
        }
        .table thead th.asc .sort-icon {
            transform: rotate(0deg); /* Up arrow */
        }
        .table thead th.desc .sort-icon {
            transform: rotate(180deg); /* Down arrow */
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #fcfcfc; /* Very subtle alternating row color */
        }
        .table-hover tbody tr:hover {
            background-color: #f0f0f0; /* Gentle hover effect */
        }
        tfoot {
            font-weight: bold;
            background-color: #f0f0f0; /* Light gray for total row */
            color: #725d68;
            border-top: 2px solid #e0e0e0;
        }
        tfoot td {
            padding: 12px 15px !important;
        }
        .badge {
            font-size: 0.85em;
            background-color: #b0aaac; /* Muted badge color */
            color: #fff;
            border-radius: 12px;
            padding: 0.4em 0.8em;
        }
        .error-message {
            color: #dc3545; /* Standard danger red, clear but not overly bright */
            font-size: 0.85em;
            margin-top: 5px;
            font-weight: 500;
        }
        .chart-container {
            width: 100%;
            max-width: 900px;
            margin: 25px auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Modal specific styles */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .modal-header {
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .modal-title {
            color: #725d68;
            font-weight: 600;
        }
        .modal-footer {
            border-top: 1px solid #e0e0e0;
            background-color: #f5f5f5;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4 text-center">Cloud POS System</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="pos-tab" data-bs-toggle="tab" data-bs-target="#pos" type="button" role="tab" aria-controls="pos" aria-selected="true">üõçÔ∏è Point-of-Sale</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">üì¶ Inventory Management</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">üìú Order History</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="sales-chart-tab" data-bs-toggle="tab" data-bs-target="#sales-chart" type="button" role="tab" aria-controls="sales-chart" aria-selected="false">üìà Sales Chart</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="pos" role="tabpanel" aria-labelledby="pos-tab">
                <h2 class="mt-4 mb-3">üõí New Order</h2>
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="posItemSelect" class="form-label">‚ú® Select Item:</label>
                        <select class="form-select" id="posItemSelect">
                            <option value="">-- Select an item --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="posQuantityInput" class="form-label">üî¢ Quantity:</label>
                        <input type="number" class="form-control" id="posQuantityInput" value="1" min="1">
                        <div id="posQuantityError" class="error-message"></div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" id="addItemToOrderBtn">‚ûï Add to Order</button>
                    </div>
                </div>

                <hr class="my-4">

                <h3>üõçÔ∏è Current Order</h3>
                <div class="table-container mb-3">
                    <table class="table table-striped table-hover" id="currentOrderTable">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td id="orderSubtotal">‚Ç± 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <button class="btn btn-success btn-lg w-100" id="checkoutBtn">‚úÖ Checkout</button>

                <h3 class="mt-4 mb-3">üíå Last Receipt:</h3>
                <pre id="receiptDisplay" class="text-start"></pre>
                <button class="btn btn-info btn-sm mt-2" id="printReceiptBtn">üñ®Ô∏è Print Last Receipt</button>
            </div>

            <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                <h2 class="mt-4 mb-3">‚ú® Add/Update Inventory Item</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="itemName" class="form-label">üç≠ Item Name:</label>
                        <input type="text" class="form-control" id="itemName" placeholder="e.g., Elegant Rose">
                        <div id="itemNameError" class="error-message"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="itemPrice" class="form-label">üí∞ Price per Unit (‚Ç±):</label>
                        <input type="number" class="form-control" id="itemPrice" step="0.01" min="0">
                        <div id="itemPriceError" class="error-message"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="itemStock" class="form-label">üì¶ Total Stock:</label>
                        <input type="number" class="form-control" id="itemStock" min="0">
                        <div id="itemStockError" class="error-message"></div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="addInventoryBtn">‚ûï Add/Update Item</button>
                    </div>
                </div>

                <hr class="my-4">

                <h3>üåü Current Inventory</h3>
                <div class="table-container">
                    <table class="table table-striped table-hover" id="inventoryTable">
                        <thead>
                            <tr>
                                <th data-sort-by="name">Item Name <span class="sort-icon"></span></th>
                                <th data-sort-by="price">Price per Unit (‚Ç±) <span class="sort-icon"></span></th>
                                <th data-sort-by="stock">Total Stock <span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                <h2 class="mt-4 mb-3">üíñ Order History</h2>
                <div id="orderHistoryList" class="d-grid gap-3">
                    <p class="text-muted" id="noHistoryMessage">No past orders found, let's make some sales! ‚ú®</p>
                </div>
            </div>

            <div class="tab-pane fade" id="sales-chart" role="tabpanel" aria-labelledby="sales-chart-tab">
                <h2 class="mt-4 mb-3">üìà Daily Sales Chart</h2>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">Alert</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Okay</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inputModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inputModalLabel">Input Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="inputModalPrompt"></p>
                    <input type="number" class="form-control" id="inputModalValue" min="0">
                    <div id="inputModalError" class="error-message mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="inputModalConfirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script>
        // --- Utility Functions for localStorage ---

        const getInventory = () => JSON.parse(localStorage.getItem('pos_inventory')) || [];
        const saveInventory = (inventory) => localStorage.setItem('pos_inventory', JSON.stringify(inventory));

        const getOrders = () => JSON.parse(localStorage.getItem('pos_orders')) || [];
        const saveOrders = (orders) => localStorage.setItem('pos_orders', JSON.stringify(orders));

        const getReceipts = () => JSON.parse(localStorage.getItem('pos_history')) || [];
        const saveReceipts = (receipts) => localStorage.setItem('pos_history', JSON.stringify(receipts));

        const getSalesData = () => JSON.parse(localStorage.getItem('sales_data')) || [];
        const saveSalesData = (salesData) => localStorage.setItem('sales_data', JSON.stringify(salesData));

        // --- Global Variables ---
        let currentOrder = []; // Stores items in the current order
        let salesChartInstance; // To hold the Chart.js instance

        // Sorting state for inventory table
        let currentSortColumn = 'name'; // Default sort column
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        // --- Modal Utility Functions ---
        const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
        const inputModal = new bootstrap.Modal(document.getElementById('inputModal'));

        function showAlertDialog(message, title = 'Alert') {
            document.getElementById('alertModalLabel').textContent = title;
            document.getElementById('alertModalBody').innerHTML = message;
            alertModal.show();
        }

        function showInputDialog(promptText, defaultValue = '', inputType = 'number', callback) {
            document.getElementById('inputModalLabel').textContent = promptText.split(':')[0]; // Use first part of prompt as title
            document.getElementById('inputModalPrompt').textContent = promptText;
            const inputField = document.getElementById('inputModalValue');
            const inputError = document.getElementById('inputModalError');

            inputField.value = defaultValue;
            inputField.type = inputType;
            inputError.textContent = ''; // Clear previous error

            const confirmBtn = document.getElementById('inputModalConfirmBtn');
            // Remove previous event listener to prevent multiple calls
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                const value = newConfirmBtn.previousElementSibling.value; // Get value from the input field
                inputError.textContent = ''; // Clear error on new attempt

                if (inputType === 'number') {
                    const parsedValue = parseFloat(value);
                    if (isNaN(parsedValue) || parsedValue < 0) {
                        inputError.textContent = 'Please enter a non-negative number.';
                        return;
                    }
                } else if (value.trim() === '') {
                    inputError.textContent = 'Input cannot be empty.';
                    return;
                }
                
                inputModal.hide();
                callback(value);
            };

            inputModal.show();
        }


        // --- Render Functions ---

        /**
         * Populates the POS dropdown with items from inventory.
         */
        const populatePosDropdown = () => {
            const inventory = getInventory();
            const posItemSelect = document.getElementById('posItemSelect');
            posItemSelect.innerHTML = '<option value="">-- Select an item --</option>'; // Clear existing options

            inventory.forEach(item => {
                // Only add items that have stock
                if (item.stock > 0) {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} (Stock: ${item.stock}, Price: ‚Ç± ${item.price.toFixed(2)})`;
                    posItemSelect.appendChild(option);
                }
            });
        };

        /**
         * Renders the current inventory in the inventory table.
         */
        const renderInventory = () => {
            let inventory = getInventory();

            // Apply sorting
            inventory.sort((a, b) => {
                let valA = a[currentSortColumn];
                let valB = b[currentSortColumn];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });


            const inventoryTableBody = document.querySelector('#inventoryTable tbody');
            inventoryTableBody.innerHTML = ''; // Clear existing rows

            // Update sort icons
            document.querySelectorAll('#inventoryTable th[data-sort-by]').forEach(th => {
                th.classList.remove('asc', 'desc');
                let sortIcon = th.querySelector('.sort-icon');
                if (!sortIcon) { // Create if it doesn't exist
                    sortIcon = document.createElement('span');
                    sortIcon.classList.add('sort-icon');
                    th.appendChild(sortIcon);
                }
                sortIcon.textContent = ''; // Clear current icon

                if (th.dataset.sortBy === currentSortColumn) {
                    th.classList.add(currentSortDirection);
                    sortIcon.textContent = currentSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                }
            });


            if (inventory.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No inventory items. Add some!</td></tr>';
                return;
            }

            inventory.forEach(item => {
                const row = inventoryTableBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `‚Ç± ${item.price.toFixed(2)}`;
                row.insertCell().textContent = item.stock;

                const actionCell = row.insertCell();
                const incrementBtn = document.createElement('button');
                incrementBtn.classList.add('btn', 'btn-sm', 'btn-secondary', 'me-2');
                incrementBtn.textContent = '‚ûï Add Stock';
                incrementBtn.onclick = () => {
                    showInputDialog(`How much stock to add for ${item.name}?`, '1', 'number', (stockToAdd) => {
                        stockToAdd = parseInt(stockToAdd);
                        if (!isNaN(stockToAdd) && stockToAdd > 0) {
                            item.stock += stockToAdd;
                            saveInventory(inventory);
                            renderInventory();
                            populatePosDropdown(); // Update POS dropdown if stock changes
                            showAlertDialog(`Successfully added ${stockToAdd} stock to ${item.name}.`, 'Stock Updated');
                        } else {
                            showAlertDialog('Invalid quantity. Please enter a positive number.', 'Input Error');
                        }
                    });
                };

                const updatePriceBtn = document.createElement('button');
                updatePriceBtn.classList.add('btn', 'btn-sm', 'btn-info');
                updatePriceBtn.textContent = '‚úèÔ∏è Update Price';
                updatePriceBtn.onclick = () => {
                    showInputDialog(`Enter new price for ${item.name}:`, item.price.toFixed(2), 'number', (newPrice) => {
                        newPrice = parseFloat(newPrice);
                        if (!isNaN(newPrice) && newPrice >= 0) {
                            item.price = newPrice;
                            saveInventory(inventory);
                            renderInventory();
                            populatePosDropdown(); // Update POS dropdown if price changes
                            showAlertDialog(`Price for ${item.name} updated to ‚Ç± ${newPrice.toFixed(2)}.`, 'Price Updated');
                        } else {
                            showAlertDialog('Invalid price. Please enter a non-negative number.', 'Input Error');
                        }
                    });
                };

                actionCell.appendChild(incrementBtn);
                actionCell.appendChild(updatePriceBtn);
            });
        };

        /**
         * Renders the current order list in the POS table.
         */
        const renderOrderList = () => {
            const orderTableBody = document.querySelector('#currentOrderTable tbody');
            orderTableBody.innerHTML = ''; // Clear existing rows
            let subtotal = 0;

            if (currentOrder.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No items in current order.</td></tr>';
            }

            currentOrder.forEach((item, index) => {
                const row = orderTableBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = `‚Ç± ${item.unitPrice.toFixed(2)}`;
                row.insertCell().textContent = `‚Ç± ${(item.quantity * item.unitPrice).toFixed(2)}`;

                const actionCell = row.insertCell();
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                removeBtn.textContent = '‚ùå Remove';
                removeBtn.onclick = () => removeItemFromOrder(index);
                actionCell.appendChild(removeBtn);

                subtotal += (item.quantity * item.unitPrice);
            });

            document.getElementById('orderSubtotal').textContent = `‚Ç± ${subtotal.toFixed(2)}`;
        };

        /**
         * Renders the order history from localStorage.
         */
        const renderHistory = () => {
            const receipts = getReceipts();
            const orderHistoryList = document.getElementById('orderHistoryList');
            orderHistoryList.innerHTML = ''; // Clear existing history

            if (receipts.length === 0) {
                orderHistoryList.innerHTML = '<p class="text-muted" id="noHistoryMessage">No past orders found, let\'s make some sales! ‚ú®</p>';
                return;
            }

            receipts.slice().reverse().forEach((receipt, index) => { // Display most recent first
                const pre = document.createElement('pre');
                pre.classList.add('mb-3');
                pre.innerHTML = receipt.receiptText; // Use innerHTML for preformatted text with newlines
                orderHistoryList.appendChild(pre);
            });
        };

        /**
         * Renders or updates the sales chart.
         */
        const renderSalesChart = () => {
            const salesData = getSalesData();
            const dailySales = {};

            // Aggregate sales by date
            salesData.forEach(sale => {
                const date = new Date(sale.timestamp).toLocaleDateString('en-US'); // Use a consistent date format
                if (!dailySales[date]) {
                    dailySales[date] = 0;
                }
                dailySales[date] += sale.amount;
            });

            // Sort dates for consistent chart display
            const sortedDates = Object.keys(dailySales).sort((a, b) => new Date(a) - new Date(b));
            const salesAmounts = sortedDates.map(date => dailySales[date]);

            const ctx = document.getElementById('salesChart').getContext('2d');

            if (salesChartInstance) {
                salesChartInstance.destroy(); // Destroy previous chart instance to re-render
            }

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Sales (‚Ç±)',
                        data: salesAmounts,
                        borderColor: '#9b8a9b', /* Muted plum for the line */
                        backgroundColor: 'rgba(155, 138, 155, 0.2)', /* Lighter fill */
                        tension: 0.2, /* Slightly smoother line */
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sales Amount (‚Ç±)',
                                color: '#725d68'
                            },
                            ticks: {
                                color: '#4a4a4a'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#725d68'
                            },
                            ticks: {
                                color: '#4a4a4a'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#725d68' /* Muted plum legend text */
                            }
                        }
                    }
                }
            });
        };

        // --- POS Tab Logic ---

        document.getElementById('addItemToOrderBtn').addEventListener('click', () => {
            const selectedItemName = document.getElementById('posItemSelect').value;
            const quantityInput = document.getElementById('posQuantityInput');
            const quantity = parseInt(quantityInput.value);
            const quantityError = document.getElementById('posQuantityError');

            quantityError.textContent = ''; // Clear previous errors

            if (!selectedItemName) {
                showAlertDialog('Please select an item.', 'Selection Required');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                quantityError.textContent = 'Quantity must be a positive number.';
                return;
            }

            const inventory = getInventory();
            const selectedItem = inventory.find(item => item.name === selectedItemName);

            if (!selectedItem) {
                showAlertDialog('Selected item not found in inventory.', 'Error');
                return;
            }

            if (selectedItem.stock < quantity) {
                quantityError.textContent = `Insufficient stock. Only ${selectedItem.stock} available.`;
                return;
            }

            // Check if item already in current order
            const existingOrderItem = currentOrder.find(item => item.name === selectedItemName);
            if (existingOrderItem) {
                // If adding more quantity would exceed stock, prevent it
                if (selectedItem.stock < (existingOrderItem.quantity + quantity)) {
                    quantityError.textContent = `Adding this much would exceed available stock (${selectedItem.stock}). Current in order: ${existingOrderItem.quantity}`;
                    return;
                }
                existingOrderItem.quantity += quantity;
            } else {
                currentOrder.push({
                    name: selectedItem.name,
                    quantity: quantity,
                    unitPrice: selectedItem.price
                });
            }

            quantityInput.value = 1; // Reset quantity input
            document.getElementById('posItemSelect').value = ''; // Clear selection
            renderOrderList();
        });

        const removeItemFromOrder = (index) => {
            currentOrder.splice(index, 1);
            renderOrderList();
        };

        document.getElementById('checkoutBtn').addEventListener('click', () => {
            if (currentOrder.length === 0) {
                showAlertDialog('The order is empty. Please add items before checking out.', 'Empty Order');
                return;
            }

            let inventory = getInventory();
            let totalCost = 0;
            let receiptText = `
    --- Official Receipt ---
    Date: ${new Date().toLocaleDateString('en-PH')}
    Time: ${new Date().toLocaleTimeString('en-PH')}
    --------------------------
    Items:
`;

            const itemsToDeduct = {}; // To handle multiple quantities of same item if added separately

            for(const orderItem of currentOrder) {
                const inventoryItem = inventory.find(inv => inv.name === orderItem.name);

                if (!inventoryItem || inventoryItem.stock < orderItem.quantity) {
                    showAlertDialog(`Error: Insufficient stock for ${orderItem.name}. Only ${inventoryItem ? inventoryItem.stock : 0} available.`, 'Stock Error');
                    return; // Prevent checkout if any item is out of stock
                }

                itemsToDeduct[orderItem.name] = (itemsToDeduct[orderItem.name] || 0) + orderItem.quantity;

                const itemTotal = orderItem.quantity * orderItem.unitPrice;
                receiptText += `- ${String(orderItem.name).padEnd(20)} x ${String(orderItem.quantity).padEnd(3)} @ ‚Ç± ${orderItem.unitPrice.toFixed(2).padEnd(6)} = ‚Ç± ${itemTotal.toFixed(2)}\n`;
                totalCost += itemTotal;
            }

            // Perform stock deduction based on aggregated quantities
            for (const itemName in itemsToDeduct) {
                const qtyToDeduct = itemsToDeduct[itemName];
                const inventoryItem = inventory.find(inv => inv.name === itemName);
                if (inventoryItem) {
                    inventoryItem.stock -= qtyToDeduct;
                }
            }

            saveInventory(inventory); // Save updated inventory

            receiptText += `
    --------------------------
    Total: ‚Ç± ${totalCost.toFixed(2)}
    --------------------------
    Thank you for your business!
`;

            // Display receipt
            document.getElementById('receiptDisplay').textContent = receiptText;

            // Save receipt in localStorage
            const receipts = getReceipts();
            receipts.push({ timestamp: new Date().toISOString(), receiptText: receiptText, totalCost: totalCost });
            saveReceipts(receipts);

            // Log total sale amount
            logSale(totalCost);

            // Clear current order
            currentOrder = [];
            renderOrderList();
            populatePosDropdown(); // Update dropdown as stock has changed
            renderSalesChart(); // Update chart with new sale

            showAlertDialog('Checkout successful! Receipt generated and stock updated.', 'Success');
        });

        document.getElementById('printReceiptBtn').addEventListener('click', () => {
            const receiptText = document.getElementById('receiptDisplay').textContent;
            if (receiptText.trim() === '') {
                showAlertDialog('No receipt to print. Please complete a sale first.', 'No Receipt');
                return;
            }

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Receipt</title>');
            printWindow.document.write('<style>body { font-family: "Segoe UI", Arial, sans-serif; margin: 20px; } pre { white-space: pre-wrap; word-wrap: break-word; font-size: 1em; color: #4a4a4a; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<pre>' + receiptText + '</pre>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

        // --- Inventory Tab Logic ---

        document.getElementById('addInventoryBtn').addEventListener('click', () => {
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);
            const itemStock = parseInt(document.getElementById('itemStock').value);

            // Clear previous error messages
            document.getElementById('itemNameError').textContent = '';
            document.getElementById('itemPriceError').textContent = '';
            document.getElementById('itemStockError').textContent = '';

            let isValid = true;
            if (itemName === '') {
                document.getElementById('itemNameError').textContent = 'Item name cannot be empty.';
                isValid = false;
            }
            if (isNaN(itemPrice) || itemPrice < 0) {
                document.getElementById('itemPriceError').textContent = 'Price must be a non-negative number.';
                isValid = false;
            }
            if (isNaN(itemStock) || itemStock < 0) {
                document.getElementById('itemStockError').textContent = 'Stock must be a non-negative integer.';
                isValid = false;
            }

            if (!isValid) {
                return; // Stop if validation fails
            }

            let inventory = getInventory();
            const existingItemIndex = inventory.findIndex(item => item.name.toLowerCase() === itemName.toLowerCase()); // Case-insensitive check

            if (existingItemIndex > -1) {
                // Update existing item
                inventory[existingItemIndex].price = itemPrice;
                inventory[existingItemIndex].stock = itemStock;
                showAlertDialog(`Inventory for "${itemName}" updated.`, 'Inventory Updated');
            } else {
                // Add new item
                inventory.push({ name: itemName, price: itemPrice, stock: itemStock });
                showAlertDialog(`"${itemName}" added to inventory.`, 'Item Added');
            }

            saveInventory(inventory);
            renderInventory();
            populatePosDropdown(); // Update dropdown with new/updated inventory
            // Clear form fields
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
        });


        // --- Sales Data Logic ---

        const logSale = (amount) => {
            const salesData = getSalesData();
            salesData.push({
                timestamp: new Date().toISOString(),
                amount: amount
            });
            saveSalesData(salesData);
        };

        // --- Inventory Table Sorting Logic ---
        document.querySelectorAll('#inventoryTable th[data-sort-by]').forEach(header => {
            header.addEventListener('click', function() {
                const sortBy = this.dataset.sortBy;

                if (currentSortColumn === sortBy) {
                    // Toggle direction if same column
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // New column, default to ascending
                    currentSortColumn = sortBy;
                    currentSortDirection = 'asc';
                }
                renderInventory(); // Re-render the table with new sort order
            });
        });


        // --- Initial Load & Tab Switching ---

        document.addEventListener('DOMContentLoaded', () => {
            renderInventory();
            populatePosDropdown();
            renderOrderList();
            renderHistory();
            renderSalesChart(); // Initial chart render

            // Event listeners for tab changes to re-render relevant content
            document.getElementById('pos-tab').addEventListener('shown.bs.tab', () => {
                populatePosDropdown(); // Ensure dropdown is fresh
                renderOrderList(); // Ensure order list is fresh
            });
            document.getElementById('inventory-tab').addEventListener('shown.bs.tab', () => renderInventory());
            document.getElementById('history-tab').addEventListener('shown.bs.tab', () => renderHistory());
            document.getElementById('sales-chart-tab').addEventListener('shown.bs.tab', () => renderSalesChart());
        });
    </script>
</body>
</html>
